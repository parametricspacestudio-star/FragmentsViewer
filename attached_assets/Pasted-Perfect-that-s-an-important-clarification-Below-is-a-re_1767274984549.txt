Perfect ‚Äî that‚Äôs an important clarification üëç
Below is a **revised, stronger prompt** where the **UI is not optional** and is explicitly defined, structured, and required.

This version tells your AI agent **exactly what UI to build**, how it behaves, and how it connects to the IFC logic.

You can paste this **verbatim** into your agent.

---

# üîπ SYSTEM / IMPLEMENTATION PROMPT (WITH MANDATORY UI)

You are a senior front-end / BIM engineer implementing a **fully interactive UI** for an IFC viewer built with **That Open Components v3.1.x**, **Fragments**, **Three.js**, and **@thatopen/ui**.

The application already loads multiple IFC and fragment files.
Your task is to implement a **visible, interactive user interface** that includes:

* A **model-aware classification tree**
* A **properties panel**
* Full **bi-directional synchronization** between UI and 3D viewport

‚ö†Ô∏è **The UI is mandatory. Headless or console-only implementations are not acceptable.**

---

## 1. UI LAYOUT (REQUIRED)

Implement the following fixed layout:

```
+------------------------------------------------------+
| Top Toolbar                                          |
| [Load IFC] [Toggle Visibility] [Reset View]          |
+--------------------+---------------------------------+
| Classification     |                                 |
| Tree Panel         |        3D Viewport              |
| (Left Sidebar)     |                                 |
|                    |                                 |
+--------------------+---------------------------------+
| Properties Panel (Bottom or Right Dock)              |
| IFC Properties / Property Sets                       |
+------------------------------------------------------+
```

### UI rules

* The **Classification Tree** MUST be visible at all times
* The **Properties Panel** MUST update on selection
* UI components must be interactive, collapsible, and scrollable
* Use **@thatopen/ui** components where possible

---

## 2. REQUIRED UI COMPONENTS

### 2.1 Classification Tree Panel

* Implement using `@thatopen/ui` Tree component
* Hierarchy MUST be:

```
Model Name
 ‚îú‚îÄ Spatial Structure
 ‚îÇ   ‚îú‚îÄ Storey
 ‚îÇ   ‚îÇ   ‚îú‚îÄ Element
 ‚îÇ   ‚îÇ   ‚îî‚îÄ Element
 ‚îî‚îÄ Entities
     ‚îú‚îÄ IfcWall
     ‚îú‚îÄ IfcDoor
     ‚îî‚îÄ ...
```

Each **leaf node** MUST store:

* `modelID`
* `fragmentID`
* `expressID`

Tree behavior:

* Clicking a leaf node highlights the element in 3D
* Expanding/collapsing nodes must be supported
* Multiple models must appear as separate root nodes

---

### 2.2 Properties Panel

* Implement as a docked panel (right or bottom)
* Displays:

  * Element name
  * GlobalId
  * Entity type
  * Property Sets (Psets)
  * Individual properties (name ‚Üí value)

Rules:

* Updates on **3D selection**
* Updates on **tree selection**
* Clears when selection is empty
* Properties must be grouped by Property Set

---

### 2.3 Toolbar

Required buttons:

* **Load IFC**
* **Toggle Visibility (Selected)**
* **Reset Camera**

Toolbar actions must operate on the **current selection**.

---

## 3. DATA ‚Üí UI PIPELINE

### 3.1 On model load

For **each FragmentsGroup**:

```ts
async function processModel(model: FragmentsGroup) {
  const indexer = components.get(OBC.IfcRelationsIndexer);
  const classifier = components.get(OBC.Classifier);

  await indexer.process(model);

  await classifier.bySpatialStructure(model);
  await classifier.byEntity(model);

  updateClassificationsTreeUI({
    modelID: model.uuid,
    modelName: model.name ?? "Unnamed model",
    classifications: classifier.list
  });
}
```

* Tree UI must update immediately after processing
* Classifications are **model-scoped**

---

## 4. TREE NODE DATA STRUCTURE (UI STATE)

```ts
interface TreeNode {
  label: string;
  modelID: string;
  fragmentID?: string;
  expressID?: number;
  children?: TreeNode[];
}
```

This structure MUST back the Tree UI.

---

## 5. TREE ‚Üí 3D INTERACTION

Clicking a tree leaf node MUST:

```ts
function selectFromTree(node: TreeNode) {
  if (!node.fragmentID || node.expressID === undefined) return;

  const highlighter = components.get(OBCF.Highlighter);

  highlighter.selection.select = {
    [node.fragmentID]: new Set([node.expressID])
  };
}
```

* The 3D viewport must visually highlight the element
* Previous selection must be cleared

---

## 6. 3D ‚Üí UI INTERACTION (PROPERTIES)

When an element is selected in the viewport, update the Properties Panel:

```ts
async function showPropertiesUI() {
  const highlighter = components.get(OBCF.Highlighter);
  const fragments = components.get(OBC.FragmentsManager);
  const indexer = components.get(OBC.IfcRelationsIndexer);

  const selection = highlighter.selection.select;
  if (Object.keys(selection).length === 0) {
    clearPropertiesPanel();
    return;
  }

  const properties: any[] = [];

  for (const fragmentID in selection) {
    const fragment = fragments.list.get(fragmentID);
    if (!fragment) continue;

    const model = fragment.group;

    for (const expressID of selection[fragmentID]) {
      properties.push(await model.getProperties(expressID));

      const psets = indexer.getEntityRelations(
        model,
        expressID,
        "IsDefinedBy"
      );

      if (!psets) continue;

      for (const psetID of psets) {
        properties.push(await model.getProperties(psetID));
      }
    }
  }

  updatePropertiesPanelUI(properties);
}
```

---

## 7. VISIBILITY TOGGLE (UI BUTTON)

```ts
function toggleVisibilityUI() {
  const highlighter = components.get(OBCF.Highlighter);
  const fragments = components.get(OBC.FragmentsManager);
  const selection = highlighter.selection.select;

  for (const fragmentID in selection) {
    const fragment = fragments.list.get(fragmentID);
    if (!fragment) continue;

    for (const id of selection[fragmentID]) {
      const hidden = fragment.hiddenItems.has(id);
      fragment.setVisibility(hidden, [id]);
    }
  }
}
```

---

## 8. PERFORMANCE & UX REQUIREMENTS

* Cache properties per `(modelID + expressID)`
* Tree updates must not block rendering
* UI must remain responsive with large IFC files
* No global singletons for model state
* All UI state must support **multiple models**

---

## 9. ACCEPTANCE CRITERIA

The implementation is complete only if:

‚úî UI panels are visible and interactive
‚úî Tree populates automatically on model load
‚úî Tree ‚Üî 3D selection sync works both ways
‚úî Properties panel updates correctly
‚úî Multiple models work simultaneously
‚úî No direct `IfcAPI` usage

---

## üîö END OF PROMPT

---

If you want next, I can:

* Convert this into a **multi-step agent plan**
* Add **UI mock component code** using `@thatopen/ui`
* Generate a **React or vanilla UI version**
* Tailor it specifically for **mobile / Replit constraints**

Just tell me what your agent needs next.

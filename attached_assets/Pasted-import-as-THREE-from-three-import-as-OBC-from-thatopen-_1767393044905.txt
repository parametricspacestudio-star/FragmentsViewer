import * as THREE from 'three';
import * as OBC from '@thatopen/components';
import * as OBCF from '@thatopen/components-front';
import * as BUI from '@thatopen/ui';
import * as BUIC from '@thatopen/ui-obc';

// Initialize UI libraries - must be done once per application
BUI.Manager.init();

// Progress bar for loading operations
class ProgressBar {
    private progressDiv: HTMLElement;

    constructor() {
        this.progressDiv = document.getElementById('progress')!;
        this.progressDiv.style.display = 'inherit';
    }

    setText(text: string) {
        this.progressDiv.textContent = text;
    }

    hide() {
        this.progressDiv.style.display = 'none';
    }
}

// Main application initialization
async function init() {
    // 1. Initialize the Components system
    const components = new OBC.Components();
    
    // 2. Create the 3D world using the modern pattern from tutorials
    const worlds = components.get(OBC.Worlds);
    const world = worlds.create<
        OBC.SimpleScene,
        OBC.OrthoPerspectiveCamera,
        OBC.SimpleRenderer
    >();
    world.name = 'main';

    // 3. Set up scene, renderer, and camera
    const sceneComponent = new OBC.SimpleScene(components);
    sceneComponent.setup();
    world.scene = sceneComponent;
    world.scene.three.background = null;

    const container = document.getElementById('container')!;
    const viewport = document.createElement('bim-viewport');
    container.appendChild(viewport);
    
    const rendererComponent = new OBC.SimpleRenderer(components, viewport);
    world.renderer = rendererComponent;

    const cameraComponent = new OBC.OrthoPerspectiveCamera(components);
    world.camera = cameraComponent;
    
    // Set initial camera position
    await world.camera.controls.setLookAt(78, 20, -2.2, 26, -4, 25);

    viewport.addEventListener('resize', () => {
        rendererComponent.resize();
        cameraComponent.updateAspect();
    });

    // 4. Initialize components and add grid
    components.init();
    const grids = components.get(OBC.Grids);
    grids.create(world);

    // 5. Set up FragmentsManager (Core Component)
    const workerUrl = 'https://thatopen.github.io/engine_fragment/resources/worker.mjs';
    const fragments = components.get(OBC.FragmentsManager);
    fragments.init(workerUrl);

    // 6. Set up Highlighter (Frontend Component) for selection
    const highlighter = components.get(OBCF.Highlighter);
    highlighter.setup({ world });
    highlighter.zoomToSelection = true;

    // 7. Set up IfcLoader for IFC conversion
    const ifcLoader = components.get(OBC.IfcLoader);
    await ifcLoader.setup({
        autoSetWasm: false,
        wasm: {
            path: 'https://unpkg.com/web-ifc@0.0.72/',
            absolute: true,
        },
    });

    // 8. Configure fragments update on camera movement
    world.camera.controls.addEventListener('rest', () => 
        fragments.core.update(true)
    );

    // 9. Handle model loading - this is the official pattern
    fragments.list.onItemSet.add(async ({ value: model }) => {
        model.useCamera(world.camera.three);
        world.scene.three.add(model.object);
        await fragments.core.update(true);
    });

    // 10. Set up UI components using @thatopen/ui-obc

    // Models List Component - shows loaded models with actions
    const [modelsList] = BUIC.tables.modelsList({
        components,
        metaDataTags: ['schema'],
        actions: { download: true },
    });

    // Spatial Tree Component - shows model hierarchy
    const [spatialTree] = BUIC.tables.spatialTree({
        components,
        models: [],
    });
    spatialTree.preserveStructureOnFilter = true;

    // Load Fragment Button
    const [loadFragBtn] = BUIC.buttons.loadFrag({ components });

    // Search functionality for spatial tree
    const onTreeSearch = (e: Event) => {
        const input = e.target as BUI.TextInput;
        spatialTree.queryString = input.value;
    };

    // Fit model to window function
    const fitModelToWindow = async () => {
        if (fragments.list.size === 0 || world.camera.controls === undefined) {
            return;
        }

        let boundingBox = new THREE.Box3();
        for (const model of fragments.core.models.list.values()) {
            const boxes = await model.getBoxes();
            for (const box of boxes) {
                boundingBox.union(box);
            }
        }
        
        const boundingSphere = boundingBox.getBoundingSphere(new THREE.Sphere());
        const perspectiveCamera = world.camera.three as THREE.PerspectiveCamera;
        const fieldOfView = perspectiveCamera.fov / 2.0;
        const center = boundingSphere.center;
        
        const centerToEye = new THREE.Vector3()
            .subVectors(perspectiveCamera.position, center)
            .normalize();
        
        const distance = boundingSphere.radius / Math.sin(THREE.MathUtils.degToRad(fieldOfView));
        const eye = new THREE.Vector3()
            .addVectors(center, centerToEye.multiplyScalar(distance));

        world.camera.controls.setLookAt(eye.x, eye.y, eye.z, center.x, center.y, center.z, true);
        fragments.core.update(true);
    };

    // Clear highlights function
    const clearHighlights = async () => {
        await highlighter.clear();
    };

    // Function to load a fragment file
    const loadFragmentFile = async (file: File) => {
        const progressBar = new ProgressBar();
        try {
            progressBar.setText('Loading fragment...');
            const buffer = await file.arrayBuffer();
            const modelId = THREE.MathUtils.generateUUID();
            
            await fragments.core.load(buffer, {
                modelId: modelId,
                raw: file.name.endsWith('.frag')
            });
        } catch (error) {
            console.error('Error loading fragment:', error);
            alert('Failed to load fragment file');
        } finally {
            progressBar.hide();
        }
    };

    // Function to load and convert IFC file
    const loadIfcFile = async (file: File) => {
        const progressBar = new ProgressBar();
        try {
            progressBar.setText('Converting IFC...');
            const buffer = await file.arrayBuffer();
            const typedArray = new Uint8Array(buffer);
            
            await ifcLoader.load(typedArray, true, file.name);
        } catch (error) {
            console.error('Error converting IFC:', error);
            alert('Failed to convert IFC file');
        } finally {
            progressBar.hide();
        }
    };

    // 11. Create the main UI panel
    const panel = BUI.Component.create(() => {
        const onLoadFragment = () => {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.frag';
            fileInput.onchange = async (event: Event) => {
                const target = event.target as HTMLInputElement;
                const file = target.files?.[0];
                if (file) await loadFragmentFile(file);
            };
            fileInput.click();
        };

        const onLoadIFC = () => {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.ifc';
            fileInput.onchange = async (event: Event) => {
                const target = event.target as HTMLInputElement;
                const file = target.files?.[0];
                if (file) await loadIfcFile(file);
            };
            fileInput.click();
        };

        return BUI.html`
            <bim-panel active label="BIM Viewer Controls" class="sidebar">
                <!-- File Operations Section -->
                <bim-panel-section label="File Operations" icon="ph:folder-open">
                    <bim-button 
                        label="Load Fragment" 
                        @click=${onLoadFragment}
                        icon="ph:file-3d">
                    </bim-button>
                    <bim-button 
                        label="Load IFC" 
                        @click=${onLoadIFC}
                        icon="ph:file-3d">
                    </bim-button>
                    ${loadFragBtn}
                </bim-panel-section>

                <!-- View Controls Section -->
                <bim-panel-section label="View Controls" icon="ph:eye">
                    <bim-button 
                        label="Fit to Window" 
                        @click=${fitModelToWindow}
                        icon="ph:arrows-in">
                    </bim-button>
                    <bim-button 
                        label="Clear Highlights" 
                        @click=${clearHighlights}
                        icon="ph:eraser">
                    </bim-button>
                </bim-panel-section>

                <!-- Loaded Models Section -->
                <bim-panel-section label="Loaded Models" icon="mage:box-3d-fill">
                    ${modelsList}
                </bim-panel-section>

                <!-- Spatial Tree Section -->
                <bim-panel-section label="Model Tree" icon="ph:tree-structure">
                    <bim-text-input 
                        @input=${onTreeSearch} 
                        placeholder="Search elements..."
                        debounce="200">
                    </bim-text-input>
                    ${spatialTree}
                </bim-panel-section>

                <!-- How to Use Section -->
                <bim-panel-section label="How to Use" icon="ph:question">
                    <div style="padding: 0.5rem;">
                        <p>1. Drag & drop .frag or .ifc files to load models</p>
                        <p>2. Click elements in the 3D view to select them</p>
                        <p>3. Use the tree to navigate model hierarchy</p>
                        <p>4. Search for specific elements in the tree</p>
                    </div>
                </bim-panel-section>
            </bim-panel>
        `;
    });

    // 12. Create the main application layout
    const app = document.createElement('bim-grid') as BUI.Grid<['main']>;
    app.layouts = {
        main: {
            template: `
                "panel viewport"
                / 28rem 1fr
            `,
            elements: { panel, viewport },
        },
    };
    app.layout = 'main';
    document.body.append(app);

    // 13. Add drag and drop functionality
    window.addEventListener('dragover', (ev: DragEvent) => {
        ev.stopPropagation();
        ev.preventDefault();
        if (ev.dataTransfer) {
            ev.dataTransfer.dropEffect = 'copy';
        }
    });

    window.addEventListener('drop', async (ev: DragEvent) => {
        ev.stopPropagation();
        ev.preventDefault();

        if (!ev.dataTransfer || ev.dataTransfer.items.length !== 1) {
            return;
        }

        const item = ev.dataTransfer.items[0];
        const file = item.getAsFile();
        if (!file) return;

        if (file.name.endsWith('.frag')) {
            await loadFragmentFile(file);
        } else if (file.name.endsWith('.ifc')) {
            await loadIfcFile(file);
        }
    });

    console.log('BIM Viewer initialized successfully!');
}

// Start the application
init().catch(console.error);